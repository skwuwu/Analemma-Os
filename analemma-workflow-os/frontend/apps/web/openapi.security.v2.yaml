openapi: 3.0.3
info:
  title: Workflow API (Security-Hardened)
  version: 2.0.0
  description: |
    ğŸ”’ Security-hardened Step Functions ë° Lambda í•¸ë“¤ëŸ¬ë¥¼ ìœ„í•œ OpenAPI ëª…ì„¸.

    ## Security Features (v2.0.0):
    - âœ… IDOR ì·¨ì•½ì  íŒ¨ì¹˜: ëª¨ë“  APIê°€ JWT claimsì—ì„œ ownerId ì¶”ì¶œ
    - âœ… WebSocket JWT ê²€ì¦: JWKS ê¸°ë°˜ ì‹¤ì œ ì„œëª… ê²€ì¦ êµ¬í˜„
    - âœ… Tenant ê²©ë¦¬: ì‚¬ìš©ìëŠ” ë³¸ì¸ì˜ ë°ì´í„°ì—ë§Œ ì ‘ê·¼ ê°€ëŠ¥
    - âœ… ë‚´ë¶€ API ë³´í˜¸: Step Functions ì „ìš© ì—”ë“œí¬ì¸íŠ¸ëŠ” ê³µê°œ ë…¸ì¶œ ì œê±°

    ## WebSocket Real-time Notifications:
    WebSocket ì—°ê²°ì€ JWT í† í° ê²€ì¦ì´ í•„ìš”í•˜ë©°, ì—°ê²° ì‹œ Authorization í—¤ë”ë¡œ Bearer í† í°ì„ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤.
    NotificationsëŠ” EventBridge â†’ Notify Lambdaë¥¼ í†µí•´ authenticated ì‚¬ìš©ìì˜ í™œì„± ì—°ê²°ë¡œë§Œ ì „ì†¡ë©ë‹ˆë‹¤.

    ## Breaking Changes from v1.0.0:
    - ownerId ì¿¼ë¦¬ ë§¤ê°œë³€ìˆ˜ ì œê±°: JWTì—ì„œ ìë™ ì¶”ì¶œ
    - /notify-hitp ì—”ë“œí¬ì¸íŠ¸ ì œê±°: ë‚´ë¶€ Step Functions ì „ìš©ìœ¼ë¡œ ë³€ê²½
servers:
  - url: http://localhost:8000
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    ExecutionStatus:
      type: object
      properties:
        executionArn:
          type: string
        status:
          type: string
          enum: [RUNNING, SUCCEEDED, FAILED, TIMED_OUT, ABORTED]
        startDate:
          type: string
          format: date-time
        stopDate:
          type: string
          format: date-time
        output:
          type: object
    ExecutionList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ExecutionStatus'
        nextToken:
          type: string
    RunWorkflowRequest:
      type: object
      properties:
        initial_state:
          type: object
          description: "Optional initial state for the workflow; large payloads should be offloaded to S3"
        callback_url:
          type: string
          format: uri
          description: "Optional callback URL to POST result when workflow completes"
        idempotency_key:
          type: string
          description: "Optional client-provided idempotency key (will be tenant-scoped by backend)"
    DesignAssistantRequest:
      type: object
      required: [request]
      properties:
        request:
          type: string
          description: User request for workflow design
security:
  - bearerAuth: []
paths:
  /workflows/{id}:
    put:
      summary: Update workflow
      description: "ì—…ë°ì´íŠ¸ ì‹œ ownerëŠ” JWTì˜ `sub` ë˜ëŠ” `ownerId` claimìœ¼ë¡œ ê²°ì •ë©ë‹ˆë‹¤. í´ë¼ì´ì–¸íŠ¸ì—ì„œ ownerIdë¥¼ ì „ë‹¬í•˜ë”ë¼ë„ ë¬´ì‹œë©ë‹ˆë‹¤."
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [config]
              properties:
                config:
                  type: object
      responses:
        '200':
          description: Workflow updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  workflowId:
                    type: string
                  name:
                    type: string
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (owner mismatch)
    delete:
      summary: Delete workflow
      description: "ì‚­ì œ ê¶Œí•œì€ JWTì˜ ownerIdë¡œ ê²€ì¦ë©ë‹ˆë‹¤."
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Workflow deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  workflowId:
                    type: string
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (owner mismatch)
  /resume:
    post:
      summary: Resume Step Functions execution (Security-Hardened)
      description: |
        ğŸ”’ Security Note: ownerIdëŠ” JWT claimsì—ì„œë§Œ ì¶”ì¶œë©ë‹ˆë‹¤.
        í´ë¼ì´ì–¸íŠ¸ì—ì„œ ownerIdë¥¼ ì œê³µí•˜ë”ë¼ë„ ë¬´ì‹œë˜ë©°, ì¸ì¦ëœ ì‚¬ìš©ìì˜ í† í°ì—ì„œë§Œ ì¶”ì¶œí•©ë‹ˆë‹¤.
        ì´ë¥¼ í†µí•´ IDOR (Insecure Direct Object Reference) ê³µê²©ì„ ë°©ì§€í•©ë‹ˆë‹¤.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [conversation_id, response]
              properties:
                execution_id:
                  type: string
                  description: "Optional: Step Functions execution ID (for direct lookup)"
                conversation_id:
                  type: string
                  description: "Required: Conversation identifier for task token lookup"
                response:
                  type: string
                  description: "Required: User response to resume the paused workflow"
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
    get:
      summary: Get resume status (optional)
      security:
        - bearerAuth: []
      parameters:
        - name: conversation_id
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Resume status
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
  /workflows:
    get:
      summary: List workflows
      description: "ownerId removed: API uses authenticated JWT `sub` claim to identify caller"
      security:
        - bearerAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
        - name: nextToken
          in: query
          schema:
            type: string
      responses:
        '200':
          description: List of workflows
          content:
            application/json:
              schema:
                type: object
                properties:
                  workflows:
                    type: array
                    items:
                      type: object
                  nextToken:
                    type: string
        '401':
          description: Unauthorized
    post:
      summary: Create workflow
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [config]
              properties:
                config:
                  type: object
      responses:
        '200':
          description: Workflow created
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  workflowId:
                    type: string
                  name:
                    type: string
        '400':
          description: Bad request
        '401':
          description: Unauthorized
  /by-name:
    get:
      summary: Get workflow by name for authenticated owner
      description: This endpoint uses the authenticated JWT `sub` claim as the ownerId; do not pass ownerId in query parameters.
      security:
        - bearerAuth: []
      parameters:
        - name: name
          in: query
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Workflow found
          content:
            application/json:
              schema:
                type: object
                properties:
                  workflowId:
                    type: string
                  ownerId:
                    type: string
                  createdAt:
                    type: integer
                  updatedAt:
                    type: integer
                  is_scheduled:
                    type: string
                  next_run_time:
                    type: integer
                  config:
                    type: object
        '401':
          description: Unauthorized
        '404':
          description: Not found
  /design-assistant:
    post:
      summary: Design assistant
      description: |
        Note: this operation is reachable via two methods in the template:
        - HttpApi (API Gateway) integration which requires Cognito JWT (`bearerAuth`) as documented here.
        - Lambda Function URL (InvokeMode: RESPONSE_STREAM) which is configured with `AuthType: NONE` to support streaming LFU clients and therefore cannot use JWT. LFU/streaming clients should call the Function URL directly for SSE responses.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DesignAssistantRequest'
      responses:
        '200':
          description: Assistant response (supports streaming via text/event-stream). The Function URL is recommended for long-running streaming responses.
          content:
            text/event-stream:
              schema:
                type: string
                description: "SSE stream of JSONL lines; each 'data: {json}\n\n' contains partial results"
            application/json:
              schema:
                type: object
                properties:
                  complexity:
                    type: string
                    enum: ["ë‹¨ìˆœ", "ë³´í†µ", "ë³µì¡"]
                  response:
                    type: object
                    properties:
                      text:
                        type: string
                      tool_use:
                        type: object
    get:
      summary: Get design assistant metadata or status
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Assistant metadata
          content:
            application/json:
              schema:
                type: object
                properties:
                  info:
                    type: string
  /workflow-assistant:
    post:
      summary: Workflow assistant (alias for design-assistant)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [request]
              properties:
                request:
                  type: string
                  description: User request for workflow design
      responses:
        '200':
          description: Assistant response (supports streaming via text/event-stream)
          content:
            text/event-stream:
              schema:
                type: string
            application/json:
              schema:
                type: object
                properties:
                  complexity:
                    type: string
                    enum: ["ë‹¨ìˆœ", "ë³´í†µ", "ë³µì¡"]
                  response:
                    type: object
                    properties:
                      text:
                        type: string
                      tool_use:
                        type: object
  /workflows/{id}/run:
    post:
      summary: Run workflow
      description: "ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì‹œì‘. ì‹¤í–‰ ë ˆì½”ë“œëŠ” JWTì˜ ownerIdë¡œ ì†Œìœ ì í•„í„°ë§ë©ë‹ˆë‹¤."
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RunWorkflowRequest'
      responses:
        '200':
          description: Returns Step Functions executionArn for the started execution
          content:
            application/json:
              schema:
                type: object
                properties:
                  executionArn:
                    type: string
                  message:
                    type: string
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
  /status:
    get:
      summary: Get Step Functions execution status (secured)
      security:
        - bearerAuth: []
      parameters:
        - name: executionArn
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Execution status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecutionStatus'
        '400':
          description: Bad request (missing executionArn)
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found or owner mismatch
  /executions:
    get:
      summary: List my executions (Paginated)
      description: |
        Fetches a paginated list of Step Function executions started by the authenticated user.
        Uses the DynamoDB GSI (ownerId-startDate-index) for fast, secure, sorted queries.
      security:
        - bearerAuth: []
      parameters:
        - name: limit
          in: query
          description: Number of items to return (default 20, max 100)
          schema:
            type: integer
            default: 20
        - name: nextToken
          in: query
          description: Opaque token for pagination from a previous response
          schema:
            type: string
      responses:
        '200':
          description: A paginated list of executions.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecutionList'
        '401':
          description: Unauthorized

# ==========================================================================
# WebSocket API Security Information (Non-OpenAPI)
# ==========================================================================
#
# WebSocket ì—°ê²° ì—”ë“œí¬ì¸íŠ¸: wss://{api-id}.execute-api.{region}.amazonaws.com/{stage}
#
# Security Requirements:
# 1. JWT Token Required: ì—°ê²° ì‹œ Authorization í—¤ë”ì— Bearer í† í° í•„ìˆ˜
# 2. JWKS Validation: ì‹¤ì œ Cognito JWKS ì„œëª… ê²€ì¦ êµ¬í˜„ë¨
# 3. Tenant Isolation: ì‚¬ìš©ìëŠ” ë³¸ì¸ì˜ ì•Œë¦¼ë§Œ ìˆ˜ì‹  ê°€ëŠ¥
#
# Connection Examples:
#
# JavaScript:
# const ws = new WebSocket('wss://api-id.execute-api.region.amazonaws.com/stage', [], {
#   headers: { 'Authorization': `Bearer ${jwtToken}` }
# });
#
# Python:
# import websockets
# headers = {"Authorization": f"Bearer {jwt_token}"}
# async with websockets.connect("wss://...", extra_headers=headers) as websocket:
#     ...
#
# Security Improvements (v2.0.0):
# - âœ… ì‹¤ì œ JWKS ì„œëª… ê²€ì¦ (ì´ì „ ê°€ì§œ ê²€ì¦ì—ì„œ ê°œì„ )
# - âœ… TTL ê¸°ë°˜ ì—°ê²° ì •ë¦¬ë¡œ stale ì—°ê²° ë°©ì§€
# - âœ… ownerId ê¸°ë°˜ ì•Œë¦¼ ê²©ë¦¬ë¡œ cross-tenant ì ‘ê·¼ ì°¨ë‹¨
#
# Internal endpoints removed:
# - /notify-hitp: ì œê±°ë¨. ì´ ê¸°ëŠ¥ì€ Step Functions ë‚´ë¶€ì—ì„œë§Œ í˜¸ì¶œë©ë‹ˆë‹¤.
#   ì™¸ë¶€ ë…¸ì¶œì´ í•„ìš” ì—†ëŠ” ë‚´ë¶€ Lambda/Step Functions í˜¸ì¶œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.
#
# Notes for implementers:
# - ëª¨ë“  ê²½ë¡œì—ì„œ ownerIdëŠ” í´ë¼ì´ì–¸íŠ¸ ì…ë ¥ì´ ì•„ë‹Œ JWT claimì—ì„œ ì¶”ì¶œë˜ì–´ ì‚¬ìš©ë©ë‹ˆë‹¤.
# - ê³µê°œ ì—”ë“œí¬ì¸íŠ¸ëŠ” bearerAuthë¡œ ë³´í˜¸ë˜ì–´ì•¼ í•˜ë©°, ë‚´ë¶€ Step Functions í˜¸ì¶œì€ ë‚´ë¶€ IAM ì—­í• ë¡œ ì œí•œë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
# - SSE/Function-URL ì‚¬ìš© ì‹œ ì¸ì¦ ë°©ì‹(ì—†ìŒ ë˜ëŠ” bearer)ì„ ìš´ì˜ ì •ì±…ì— ë§ì¶° ë¬¸ì„œí™”í•˜ì„¸ìš”.
