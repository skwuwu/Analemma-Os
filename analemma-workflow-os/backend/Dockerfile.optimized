# ============================================================
# ğŸš€ Optimized Multi-Stage Dockerfile for Lambda Cold Start
# ============================================================
#
# v2.0 Cold Start Optimization:
#   - Multi-stage buildë¡œ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì œê±°
#   - __pycache__, *.pyc, dist-info ë“± ë¶ˆí•„ìš” íŒŒì¼ ì‚­ì œ
#   - Python ë°”ì´íŠ¸ì½”ë“œ ì‚¬ì „ ì»´íŒŒì¼ (compileall)
#   - pip --no-cache-dir ì ìš©
#   - boto3/botocore ì œì™¸ (Lambda ëŸ°íƒ€ì„ì— ì´ë¯¸ í¬í•¨)
#
# ì˜ˆìƒ íš¨ê³¼:
#   - ì´ë¯¸ì§€ í¬ê¸° 30-50% ê°ì†Œ
#   - Cold Start ì‹œê°„ 20-30% ë‹¨ì¶•
# ============================================================

# ========================================
# Stage 1: Builder (íŒ¨í‚¤ì§€ ì„¤ì¹˜)
# ========================================
FROM public.ecr.aws/lambda/python:3.12 AS builder

# ë¹Œë“œ í™˜ê²½ ë³€ìˆ˜
ENV PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# requirements.txt ë³µì‚¬ ë° íŒ¨í‚¤ì§€ ì„¤ì¹˜
COPY requirements.txt /tmp/requirements.txt

# boto3/botocore ì œì™¸ (Lambda ëŸ°íƒ€ì„ì— ì´ë¯¸ í¬í•¨)
# ì´ë¯¸ ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ì™€ ë²„ì „ ì¶©ëŒì„ ë°©ì§€í•˜ê³  ì´ë¯¸ì§€ í¬ê¸° ê°ì†Œ
RUN grep -v -E "^boto3|^botocore" /tmp/requirements.txt > /tmp/requirements-filtered.txt || true && \
    pip install --no-cache-dir --target /opt/python/lib/python3.12/site-packages \
        -r /tmp/requirements-filtered.txt

# ë¶ˆí•„ìš”í•œ íŒŒì¼ ì œê±° (ì´ë¯¸ì§€ ê²½ëŸ‰í™”)
RUN find /opt/python -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true && \
    find /opt/python -type d -name "*.dist-info" -exec rm -rf {} + 2>/dev/null || true && \
    find /opt/python -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true && \
    find /opt/python -type d -name "docs" -exec rm -rf {} + 2>/dev/null || true && \
    find /opt/python -type d -name "examples" -exec rm -rf {} + 2>/dev/null || true && \
    find /opt/python -name "*.pyc" -delete 2>/dev/null || true && \
    find /opt/python -name "*.pyo" -delete 2>/dev/null || true && \
    find /opt/python -name "*.so" -type f ! -name "_*.so" -delete 2>/dev/null || true

# ========================================
# Stage 2: Runtime (ìµœì¢… ì´ë¯¸ì§€)
# ========================================
FROM public.ecr.aws/lambda/python:3.12 AS runtime

# ëŸ°íƒ€ì„ ìµœì í™” í™˜ê²½ ë³€ìˆ˜
ENV PYTHONOPTIMIZE=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    # AWS SDK ìµœì í™”
    AWS_SDK_LOAD_CONFIG=1 \
    # Lambda Powertools ìµœì í™”
    POWERTOOLS_DEV=0 \
    POWERTOOLS_LOG_DEDUPLICATION_DISABLED=1

# Builderì—ì„œ site-packagesë§Œ ë³µì‚¬
COPY --from=builder /opt/python/lib/python3.12/site-packages ${LAMBDA_TASK_ROOT}/

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬
COPY . ${LAMBDA_TASK_ROOT}/

# Python ë°”ì´íŠ¸ì½”ë“œ ì‚¬ì „ ì»´íŒŒì¼ (Cold Start ìµœì í™”)
# - ëŸ°íƒ€ì„ì— ì»´íŒŒì¼ ë¶ˆí•„ìš”ë¡œ import ì†ë„ 5-10% í–¥ìƒ
RUN python -m compileall -q ${LAMBDA_TASK_ROOT}/ 2>/dev/null || true

# ì»´íŒŒì¼ í›„ ì†ŒìŠ¤ íŒŒì¼ ìºì‹œ ì •ë¦¬ (ì„ íƒì )
# RUN find ${LAMBDA_TASK_ROOT} -name "*.py" -delete

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR ${LAMBDA_TASK_ROOT}

# HandlerëŠ” template.yamlì˜ ImageConfig.Commandì—ì„œ ì§€ì •
