{
    "workflow_name": "Dynamic Loop Limit Test - 30 Iterations",
    "description": "Tests dynamic loop limit calculation: 3 nodes × 30 iterations = 90 weighted executions",
    "nodes": [
        {
            "id": "prep",
            "type": "operator",
            "label": "Test Preparation",
            "config": {
                "language": "python",
                "code": "print('Dynamic Loop Limit Test Started')\nstate['test_started'] = True\nstate['counter'] = 0\nstate['loop_items'] = list(range(30))  # 30 iterations\nprint(f'Prepared {len(state[\"loop_items\"])} iterations')"
            }
        },
        {
            "id": "heavy_loop",
            "type": "for_each",
            "label": "Heavy Loop - 30 Iterations × 3 Nodes",
            "config": {
                "input_list_key": "loop_items",
                "max_iterations": 30,
                "output_key": "loop_results",
                "sub_workflow": {
                    "nodes": [
                        {
                            "id": "loop_node_1",
                            "type": "operator",
                            "config": {
                                "language": "python",
                                "code": "state['counter'] = state.get('counter', 0) + 1\nstate['step_1_done'] = True"
                            }
                        },
                        {
                            "id": "loop_node_2",
                            "type": "operator",
                            "config": {
                                "language": "python",
                                "code": "state['doubled'] = state['counter'] * 2\nstate['step_2_done'] = True"
                            }
                        },
                        {
                            "id": "loop_node_3",
                            "type": "operator",
                            "config": {
                                "language": "python",
                                "code": "state['result'] = f'Iteration {state[\"counter\"]}'\nstate['step_3_done'] = True"
                            }
                        }
                    ],
                    "edges": [
                        {"source": "loop_node_1", "target": "loop_node_2"},
                        {"source": "loop_node_2", "target": "loop_node_3"}
                    ],
                    "start_node": "loop_node_1"
                }
            }
        },
        {
            "id": "validator",
            "type": "operator",
            "label": "Validate Dynamic Limit Calculation",
            "config": {
                "language": "python",
                "code": "# Validation: System should calculate dynamic limit\n# Expected: 3 nodes × 30 iterations = 90 + safety margin(~20) = 110+\n\nexpected_weighted_executions = 90  # 3 × 30\nexpected_min_limit = expected_weighted_executions + 18  # 20% margin\n\nactual_limit = state.get('max_loop_iterations', 0)\nactual_counter = state.get('counter', 0)\n\n# Validation checks\nchecks = [\n    ('weighted_calculation', actual_limit >= expected_min_limit, f'limit={actual_limit} >= {expected_min_limit}'),\n    ('all_iterations_completed', actual_counter == 30, f'counter={actual_counter}'),\n    ('no_limit_exceeded', True, 'No LoopLimitExceeded error')\n]\n\nall_passed = all(c[1] for c in checks)\n\nstate['validation_checks'] = {\n    'expected_weighted_executions': expected_weighted_executions,\n    'expected_min_limit': expected_min_limit,\n    'actual_limit': actual_limit,\n    'actual_counter': actual_counter,\n    'checks': [{'name': c[0], 'passed': c[1], 'details': c[2]} for c in checks]\n}\n\nif all_passed:\n    state['TEST_RESULT'] = f'PASS: Dynamic limit={actual_limit}, executions={actual_counter}/30'\nelse:\n    failed = [c[0] for c in checks if not c[1]]\n    state['TEST_RESULT'] = f'FAIL: {failed}'\n\nstate['test_passed'] = all_passed\n\nprint(f'Validation complete: {state[\"TEST_RESULT\"]}')"
            }
        }
    ],
    "edges": [
        {"source": "prep", "target": "heavy_loop"},
        {"source": "heavy_loop", "target": "validator"}
    ],
    "start_node": "prep",
    "metadata": {
        "test_features": [
            "dynamic_loop_limit",
            "weighted_execution_calculation",
            "for_each_segment_counting"
        ],
        "expected_behavior": "System calculates max_loop_iterations = 90 + 20% ≈ 108+, workflow completes without LoopLimitExceeded"
    }
}
