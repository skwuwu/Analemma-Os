{
    "workflow_name": "Loop + Branch + Stress Test",
    "description": "[Complex] 루프 내부 분기 + 상태 축적 + S3 오프로드 복구 + HITL 중첩 테스트",
    "version": "1.0.0",
    "test_category": "complex_integration",
    "nodes": [
        {
            "id": "stress_init",
            "type": "operator_official",
            "config": {
                "strategy": "echo",
                "input": [
                    0,
                    1,
                    2,
                    3,
                    4
                ],
                "output_key": "loop_items"
            },
            "label": "복합 스트레스 초기화"
        },
        {
            "id": "stress_init_2",
            "type": "operator_official",
            "config": {
                "strategy": "echo",
                "input": 0,
                "output_key": "loop_counter"
            }
        },
        {
            "id": "stress_init_3",
            "type": "operator_official",
            "config": {
                "strategy": "echo",
                "input": 5,
                "output_key": "max_loop_iterations"
            }
        },
        {
            "id": "stress_init_4",
            "type": "operator_official",
            "config": {
                "strategy": "echo",
                "input": [],
                "output_key": "accumulated_results"
            }
        },
        {
            "id": "stress_init_5",
            "type": "operator_official",
            "config": {
                "strategy": "echo",
                "input": 0,
                "output_key": "offload_triggered_count"
            }
        },
        {
            "id": "stress_init_6",
            "type": "operator_official",
            "config": {
                "strategy": "echo",
                "input": 0,
                "output_key": "branch_execution_count"
            }
        },
        {
            "id": "stress_init_7",
            "type": "operator_official",
            "config": {
                "strategy": "echo",
                "input": 25,
                "output_key": "data_per_iteration_kb"
            }
        },
        {
            "id": "loop_processor",
            "type": "for_each",
            "label": "루프 프로세서 (내부 분기 포함)",
            "config": {
                "input_list_key": "loop_items",
                "output_key": "loop_results",
                "max_iterations": 5,
                "sub_workflow": {
                    "nodes": [
                        {
                            "id": "loop_iteration_start",
                            "type": "operator_official",
                            "config": {
                                "strategy": "echo",
                                "input": true,
                                "output_key": "step_1_done"
                            },
                            "label": "반복 시작"
                        },
                        {
                            "id": "branch_decision",
                            "type": "operator_official",
                            "config": {
                                "strategy": "echo",
                                "input": "even_path",
                                "output_key": "branch_route"
                            },
                            "label": "분기 결정"
                        },
                        {
                            "id": "parallel_branch_node",
                            "type": "parallel_group",
                            "label": "병렬 분기",
                            "branches": [
                                {
                                    "id": "branch_a",
                                    "name": "Branch A",
                                    "nodes": [
                                        {
                                            "id": "branch_a_llm",
                                            "type": "aiModel",
                                            "label": "Branch A LLM",
                                            "config": {
                                                "model": "gemini-2.0-flash",
                                                "system_prompt": "You are a test assistant for Branch A. Return JSON only.",
                                                "user_prompt": "Return {\"branch\": \"A\", \"status\": \"processed\"}",
                                                "output_key": "branch_a_result",
                                                "max_tokens": 50
                                            }
                                        }
                                    ]
                                },
                                {
                                    "id": "branch_b",
                                    "name": "Branch B",
                                    "nodes": [
                                        {
                                            "id": "branch_b_llm",
                                            "type": "aiModel",
                                            "label": "Branch B LLM",
                                            "config": {
                                                "model": "gemini-2.0-flash",
                                                "system_prompt": "You are a test assistant for Branch B. Return JSON only.",
                                                "user_prompt": "Return {\"branch\": \"B\", \"status\": \"processed\"}",
                                                "output_key": "branch_b_result",
                                                "max_tokens": 50
                                            }
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            "id": "accumulate_results",
                            "type": "operator_official",
                            "config": {
                                "strategy": "echo",
                                "input": true,
                                "output_key": "step_accumulated"
                            },
                            "label": "결과 축적"
                        }
                    ],
                    "edges": [
                        {
                            "source": "loop_iteration_start",
                            "target": "branch_decision"
                        },
                        {
                            "source": "branch_decision",
                            "target": "parallel_branch_node"
                        },
                        {
                            "source": "parallel_branch_node",
                            "target": "accumulate_results"
                        }
                    ]
                }
            }
        },
        {
            "id": "hitp_checkpoint",
            "type": "operator_official",
            "config": {
                "strategy": "echo",
                "input": {
                    "requires_approval": true,
                    "approval_message": "Loop completed. Approve?"
                },
                "output_key": "hitp_checkpoint"
            },
            "label": "HITL 체크포인트 (루프 완료 후 승인)"
        },
        {
            "id": "hitp_checkpoint_2",
            "type": "operator_official",
            "config": {
                "strategy": "echo",
                "input": true,
                "output_key": "hitp_triggered"
            }
        },
        {
            "id": "count_branch_executions",
            "type": "operator_official",
            "config": {
                "strategy": "list_count",
                "input_key": "loop_results",
                "output_key": "workflow_loop_count"
            },
            "label": "루프 실행 횟수 집계"
        },
        {
            "id": "copy_branch_count",
            "type": "operator_official",
            "config": {
                "strategy": "math_expression",
                "input_key": "workflow_loop_count",
                "params": { "expression": "x + 0" },
                "output_key": "branch_execution_count"
            },
            "label": "브랜치 실행 횟수 복사"
        },
        {
            "id": "compute_state_size",
            "type": "operator_official",
            "config": {
                "strategy": "get_state_size",
                "output_key": "accumulated_size_kb"
            },
            "label": "현재 State 크기 측정 (KB)"
        },
        {
            "id": "check_offload_state",
            "type": "operator_official",
            "config": {
                "strategy": "if_else",
                "input_key": "accumulated_size_kb",
                "params": {
                    "condition": "$ > 100",
                    "then": 1,
                    "else": 0
                },
                "output_key": "offload_triggered_count"
            },
            "label": "S3 오프로드 트리거 확인"
        },
        {
            "id": "final_validator",
            "type": "operator_official",
            "config": {
                "strategy": "echo",
                "input": "LOOP+BRANCH STRESS PASSED",
                "output_key": "TEST_RESULT"
            },
            "label": "통합 검증"
        },
        {
            "id": "final_validator_2",
            "type": "operator_official",
            "config": {
                "strategy": "echo",
                "input": "PASSED",
                "output_key": "VALIDATION_STATUS"
            }
        }
    ],
    "edges": [
        {
            "source": "final_validator",
            "target": "final_validator_2"
        },
        {
            "source": "hitp_checkpoint",
            "target": "hitp_checkpoint_2"
        },
        {
            "source": "stress_init_6",
            "target": "stress_init_7"
        },
        {
            "source": "stress_init_5",
            "target": "stress_init_6"
        },
        {
            "source": "stress_init_4",
            "target": "stress_init_5"
        },
        {
            "source": "stress_init_3",
            "target": "stress_init_4"
        },
        {
            "source": "stress_init_2",
            "target": "stress_init_3"
        },
        {
            "source": "stress_init",
            "target": "stress_init_2"
        },
        {
            "source": "stress_init_7",
            "target": "loop_processor"
        },
        {
            "source": "loop_processor",
            "target": "hitp_checkpoint",
            "type": "hitp"
        },
        {
            "source": "hitp_checkpoint_2",
            "target": "count_branch_executions"
        },
        {
            "source": "count_branch_executions",
            "target": "copy_branch_count"
        },
        {
            "source": "copy_branch_count",
            "target": "compute_state_size"
        },
        {
            "source": "compute_state_size",
            "target": "check_offload_state"
        },
        {
            "source": "check_offload_state",
            "target": "final_validator"
        }
    ],
    "start_node": "stress_init",
    "metadata": {
        "test_features": [
            "loop_processing",
            "conditional_branching",
            "parallel_execution",
            "state_accumulation",
            "s3_offload_trigger",
            "hitp_after_loop",
            "llm_in_branches"
        ],
        "expected_behavior": "루프 5회 반복, 병렬 분기, HITL 승인 후 검증",
        "complexity_score": 9.5
    }
}