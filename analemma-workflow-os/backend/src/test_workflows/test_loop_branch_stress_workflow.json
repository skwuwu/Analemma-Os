{
    "workflow_name": "Loop + Branch + Stress Test",
    "description": "[Complex] 루프 내부 분기 + 상태 축적 + S3 오프로드 복구 + HITL 중첩 테스트",
    "version": "1.0.0",
    "test_category": "complex_integration",
    "nodes": [
        {
            "id": "stress_init",
            "type": "sets",
            "label": "복합 스트레스 초기화",
            "config": {
                "sets": [
                    {"key": "loop_items", "value": [0, 1, 2, 3, 4]},
                    {"key": "loop_counter", "value": 0},
                    {"key": "max_loop_iterations", "value": 5},
                    {"key": "accumulated_results", "value": []},
                    {"key": "offload_triggered_count", "value": 0},
                    {"key": "branch_execution_count", "value": 0},
                    {"key": "data_per_iteration_kb", "value": 25}
                ]
            }
        },
        {
            "id": "loop_processor",
            "type": "for_each",
            "label": "루프 프로세서 (내부 분기 포함)",
            "config": {
                "input_list_key": "loop_items",
                "output_key": "loop_results",
                "max_iterations": 5,
                "sub_workflow": {
                    "nodes": [
                        {
                            "id": "loop_iteration_start",
                            "type": "sets",
                            "label": "반복 시작",
                            "config": {
                                "sets": [
                                    {"key": "step_1_done", "value": true}
                                ]
                            }
                        },
                        {
                            "id": "branch_decision",
                            "type": "sets",
                            "label": "분기 결정",
                            "config": {
                                "sets": [
                                    {"key": "branch_route", "value": "even_path"}
                                ]
                            }
                        },
                        {
                            "id": "parallel_branch_node",
                            "type": "parallel_group",
                            "label": "병렬 분기",
                            "branches": [
                                {
                                    "id": "branch_a",
                                    "name": "Branch A",
                                    "nodes": [
                                        {
                                            "id": "branch_a_llm",
                                            "type": "aiModel",
                                            "label": "Branch A LLM",
                                            "config": {
                                                "model": "gemini-2.0-flash",
                                                "system_prompt": "You are a test assistant for Branch A. Return JSON only.",
                                                "user_prompt": "Return {\"branch\": \"A\", \"status\": \"processed\"}",
                                                "output_key": "branch_a_result",
                                                "max_tokens": 50
                                            }
                                        }
                                    ]
                                },
                                {
                                    "id": "branch_b",
                                    "name": "Branch B",
                                    "nodes": [
                                        {
                                            "id": "branch_b_llm",
                                            "type": "aiModel",
                                            "label": "Branch B LLM",
                                            "config": {
                                                "model": "gemini-2.0-flash",
                                                "system_prompt": "You are a test assistant for Branch B. Return JSON only.",
                                                "user_prompt": "Return {\"branch\": \"B\", \"status\": \"processed\"}",
                                                "output_key": "branch_b_result",
                                                "max_tokens": 50
                                            }
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            "id": "accumulate_results",
                            "type": "sets",
                            "label": "결과 축적",
                            "config": {
                                "sets": [
                                    {"key": "step_accumulated", "value": true}
                                ]
                            }
                        }
                    ],
                    "edges": [
                        {"source": "loop_iteration_start", "target": "branch_decision"},
                        {"source": "branch_decision", "target": "parallel_branch_node"},
                        {"source": "parallel_branch_node", "target": "accumulate_results"}
                    ]
                }
            }
        },
        {
            "id": "hitp_checkpoint",
            "type": "sets",
            "hitp": true,
            "label": "HITL 체크포인트 (루프 완료 후 승인)",
            "config": {
                "sets": [
                    {"key": "hitp_checkpoint", "value": {"requires_approval": true, "approval_message": "Loop completed. Approve?"}},
                    {"key": "hitp_triggered", "value": true}
                ]
            }
        },
        {
            "id": "final_validator",
            "type": "sets",
            "label": "통합 검증",
            "config": {
                "sets": [
                    {"key": "TEST_RESULT", "value": "LOOP+BRANCH STRESS PASSED"},
                    {"key": "VALIDATION_STATUS", "value": "PASSED"}
                ]
            }
        }
    ],
    "edges": [
        {"source": "stress_init", "target": "loop_processor"},
        {"source": "loop_processor", "target": "hitp_checkpoint", "type": "hitp"},
        {"source": "hitp_checkpoint", "target": "final_validator"}
    ],
    "start_node": "stress_init",
    "metadata": {
        "test_features": [
            "loop_processing",
            "conditional_branching",
            "parallel_execution",
            "state_accumulation",
            "s3_offload_trigger",
            "hitp_after_loop",
            "llm_in_branches"
        ],
        "expected_behavior": "루프 5회 반복, 병렬 분기, HITL 승인 후 검증",
        "complexity_score": 9.5
    }
}
