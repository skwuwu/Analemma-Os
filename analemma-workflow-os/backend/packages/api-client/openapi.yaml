openapi: 3.0.3
info:
  title: Workflow API (Security-Hardened)
  version: 2.0.0
  description: |
    ðŸ”’ OpenAPI specification for security-hardened Step Functions and Lambda handlers.
    
    ## Security Features (v2.0.0):
    - âœ… IDOR vulnerability patch: All APIs extract ownerId from JWT claims
    - âœ… WebSocket JWT validation: Implemented actual signature verification based on JWKS
    - âœ… Tenant isolation: Users can only access their own data
    - âœ… Internal API protection: Step Functions-only endpoints removed from public exposure
    
    ## WebSocket Real-time Notifications:
    WebSocket connections require JWT token verification, and must provide Bearer token in Authorization header when connecting.
    Notifications are sent only to authenticated users' active connections through EventBridge â†’ Notify Lambda.
    
    ## Breaking Changes from v1.0.0:
    - ownerId query parameter removed: Automatically extracted from JWT
    - /notify-hitp endpoint removed: Changed to Step Functions internal only
servers:
  - url: https://wxis03rjce.execute-api.ap-northeast-2.amazonaws.com
    description: Production API (AWS API Gateway)
  - url: http://localhost:8000
    description: Local development server
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    ExecutionStatus:
      type: object
      properties:
        executionArn:
          type: string
        status:
          type: string
          enum: [RUNNING, SUCCEEDED, FAILED, TIMED_OUT, ABORTED]
        startDate:
          type: string
          format: date-time
        stopDate:
          type: string
          format: date-time
        output:
          type: object
    ExecutionList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ExecutionStatus'
        nextToken:
          type: string
    RunWorkflowRequest:
      type: object
      properties:
        initial_state:
          type: object
          description: "Optional initial state for the workflow; large payloads should be offloaded to S3"
        callback_url:
          type: string
          format: uri
          description: "Optional callback URL to POST result when workflow completes"
        idempotency_key:
          type: string
          description: "Optional client-provided idempotency key (will be tenant-scoped by backend)"
    DesignAssistantRequest:
      type: object
      required: [request]
      properties:
        request:
          type: string
          description: User request for workflow design
    # =========================================================================
    # Task Manager Schemas (v2.1)
    # =========================================================================
    TaskSummary:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        status:
          type: string
          enum: [queued, in_progress, pending_approval, completed, failed, cancelled]
        progress_pct:
          type: number
          minimum: 0
          maximum: 100
        eta_display:
          type: string
          description: "Human-readable ETA (e.g., '~3 min', 'Pending')"
        confidence_score:
          type: number
          minimum: 0
          maximum: 1
        created_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true
        pending_action:
          $ref: '#/components/schemas/PendingAction'
        quick_fix:
          $ref: '#/components/schemas/QuickFix'
    TaskDetail:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        status:
          type: string
          enum: [queued, in_progress, pending_approval, completed, failed, cancelled]
        progress_pct:
          type: number
        eta_display:
          type: string
        confidence_score:
          type: number
        confidence_components:
          $ref: '#/components/schemas/ConfidenceComponents'
        autonomy_rate:
          type: number
          description: "0.0 ~ 1.0, ratio of auto-completed steps"
        autonomy_display:
          type: string
          description: "Human-readable autonomy (e.g., '85% Auto')"
        throughput:
          type: number
          description: "Tokens per minute"
        throughput_display:
          type: string
          description: "Human-readable throughput (e.g., '1.2k tok/min')"
        thought_history:
          type: array
          items:
            $ref: '#/components/schemas/ThoughtStep'
        artifacts:
          type: array
          items:
            $ref: '#/components/schemas/Artifact'
        intervention_history:
          $ref: '#/components/schemas/InterventionHistory'
        created_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true
        pending_action:
          $ref: '#/components/schemas/PendingAction'
        quick_fix:
          $ref: '#/components/schemas/QuickFix'
    TaskListResponse:
      type: object
      properties:
        tasks:
          type: array
          items:
            $ref: '#/components/schemas/TaskSummary'
        total:
          type: integer
          description: "Total number of tasks matching filter"
        filters_applied:
          type: object
          properties:
            status:
              type: string
              nullable: true
            include_completed:
              type: boolean
    TaskMetrics:
      type: object
      properties:
        confidence_score:
          type: number
        confidence_components:
          $ref: '#/components/schemas/ConfidenceComponents'
        autonomy_rate:
          type: number
        autonomy_display:
          type: string
        throughput:
          type: number
        throughput_display:
          type: string
        eta_display:
          type: string
    ConfidenceComponents:
      type: object
      properties:
        data_quality:
          type: number
          description: "0.0 ~ 1.0"
        model_certainty:
          type: number
          description: "0.0 ~ 1.0"
        validation_pass_rate:
          type: number
          description: "0.0 ~ 1.0"
    PendingAction:
      type: object
      properties:
        type:
          type: string
          enum: [approve, reject, modify, provide_input]
        message:
          type: string
        options:
          type: array
          items:
            type: string
        step_execution_id:
          type: string
    QuickFix:
      type: object
      properties:
        type:
          type: string
          enum: [retry, skip, rollback, abort]
        label:
          type: string
        description:
          type: string
    QuickFixRequest:
      type: object
      required: [task_id, action]
      properties:
        task_id:
          type: string
        action:
          type: string
          enum: [retry, skip, rollback, abort]
        options:
          type: object
          description: "Action-specific options (e.g., {step_id: '...', with_modified_input: {...}})"
    ThoughtStep:
      type: object
      properties:
        step_id:
          type: string
        order:
          type: integer
        type:
          type: string
          enum: [planning, execution, validation, human_in_the_loop]
        summary:
          type: string
        detail:
          type: string
        timestamp:
          type: string
          format: date-time
        duration_ms:
          type: integer
        status:
          type: string
          enum: [completed, in_progress, pending, failed, skipped]
    Artifact:
      type: object
      properties:
        artifact_id:
          type: string
        type:
          type: string
          enum: [code, document, data, image, config]
        name:
          type: string
        summary:
          type: string
        content_url:
          type: string
          format: uri
          description: "Pre-signed S3 URL for artifact content"
        created_at:
          type: string
          format: date-time
    InterventionHistory:
      type: object
      properties:
        total_count:
          type: integer
        auto_resolved_count:
          type: integer
        human_resolved_count:
          type: integer
        interventions:
          type: array
          items:
            $ref: '#/components/schemas/InterventionEntry'
        summary:
          type: string
          description: "Human-readable summary (e.g., '3 interventions, 2 auto-resolved')"
    InterventionEntry:
      type: object
      properties:
        type:
          type: string
          enum: [validation_failure, approval_required, error_recovery, user_input]
        timestamp:
          type: string
          format: date-time
        resolution:
          type: string
          enum: [auto, human, pending]
        description:
          type: string
    OutcomesResponse:
      type: object
      properties:
        outcomes:
          type: array
          items:
            $ref: '#/components/schemas/Artifact'
        total:
          type: integer
    ReasoningPathResponse:
      type: object
      properties:
        artifact_id:
          type: string
        reasoning_steps:
          type: array
          items:
            $ref: '#/components/schemas/ReasoningStep'
        total_steps:
          type: integer
        total_duration_seconds:
          type: number
          nullable: true
          description: "Total time taken for all reasoning steps in seconds"
    ReasoningStep:
      type: object
      properties:
        step_id:
          type: string
        step_type:
          type: string
          enum: [decision, action, observation, thought]
        content:
          type: string
        timestamp:
          type: string
          format: date-time
        confidence:
          type: number
          minimum: 0
          maximum: 1
          nullable: true
        node_id:
          type: string
          nullable: true
security:
  - bearerAuth: []
paths:
  /workflows/{id}:
    get:
      summary: Get workflow by ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Workflow details
          content:
            application/json:
              schema:
                type: object
                properties:
                  workflowId:
                    type: string
                  name:
                    type: string
                  createdAt:
                    type: integer
                  updatedAt:
                    type: integer
                  config:
                    type: object
                  is_scheduled:
                    type: boolean
                  next_run_time:
                    type: integer
        '404':
          description: Workflow not found
      security:
        - bearerAuth: []
    delete:
      summary: Delete workflow
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Workflow deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "deleted"
      security:
        - bearerAuth: []
  /resume:
    post:
      summary: Resume workflow (HITP)
      description: Resume a paused workflow with user input for Human-in-the-Loop processing.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [conversation_id, user_input]
              properties:
                conversation_id:
                  type: string
                  description: "Required: Conversation identifier for task token lookup"
                user_input:
                  type: object
                  description: "Required: User input data for resuming the workflow"
      responses:
        '200':
          description: Workflow resumed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Workflow resumed"
                  executionArn:
                    type: string
        '404':
          description: TaskToken not found
        '403':
          description: Forbidden
      security:
        - bearerAuth: []
  /workflows:
    get:
      summary: List workflows
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
            maximum: 100
        - name: nextToken
          in: query
          schema:
            type: string
      responses:
        '200':
          description: List of workflows
          content:
            application/json:
              schema:
                type: object
                properties:
                  workflows:
                    type: array
                    items:
                      type: object
                      properties:
                        name:
                          type: string
                        workflowId:
                          type: string
                        nextToken:
                          type: string
                  nextToken:
                    type: string
      security:
        - bearerAuth: []
    post:
      summary: Create or save workflow
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [config]
              properties:
                name:
                  type: string
                config:
                  type: object
                  description: "Workflow configuration with nodes and edges"
                is_scheduled:
                  type: boolean
                next_run_time:
                  type: integer
                workflowId:
                  type: string
      responses:
        '200':
          description: Workflow created or saved
          content:
            application/json:
              schema:
                type: object
                properties:
                  workflowId:
                    type: string
                  message:
                    type: string
      security:
        - bearerAuth: []
  /by-name:
    get:
      summary: Get workflow by name
      parameters:
        - name: name
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Workflow details
          content:
            application/json:
              schema:
                type: object
                properties:
                  workflowId:
                    type: string
                  name:
                    type: string
                  createdAt:
                    type: integer
                  updatedAt:
                    type: integer
                  config:
                    type: object
      security:
        - bearerAuth: []
  /workflows/{id}/run:
    post:
      summary: Run workflow
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                input_data:
                  type: object
                  description: "Input data or raw initial state"
                test_keyword:
                  type: string
                Idempotency-Key:
                  type: string
      responses:
        '200':
          description: Workflow execution started
          content:
            application/json:
              schema:
                type: object
                properties:
                  executionArn:
                    type: string
                  startDate:
                    type: string
                    format: date-time
      security:
        - bearerAuth: []
  /status:
    get:
      summary: Get execution status
      parameters:
        - name: executionArn
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Execution status
          content:
            application/json:
              schema:
                type: object
                properties:
                  type:
                    type: string
                    example: "workflow_status"
                  payload:
                    type: object
        '404':
          description: Not found or owner mismatch
      security:
        - bearerAuth: []
  /executions:
    get:
      summary: List executions
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: nextToken
          in: query
          schema:
            type: string
      responses:
        '200':
          description: List of executions
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      type: object
                      description: "Full DynamoDB item"
                  nextToken:
                    type: string
      security:
        - bearerAuth: []
  /executions/{id}:
    get:
      summary: Get execution details
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Execution details
          content:
            application/json:
              schema:
                type: object
                properties:
                  executionArn:
                    type: string
                  status:
                    type: string
                    enum: [RUNNING, SUCCEEDED, FAILED, TIMED_OUT, ABORTED]
                  startDate:
                    type: string
                    format: date-time
                  stopDate:
                    type: string
                    format: date-time
                  input:
                    type: object
                  output:
                    type: object
                  error:
                    type: string
                  workflowId:
                    type: string
        '404':
          description: Execution not found
      security:
        - bearerAuth: []
  /executions/{id}/stop:
    post:
      summary: Stop execution
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Execution stopped
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Execution stopped"
        '404':
          description: Execution not found
        '400':
          description: Cannot stop execution
      security:
        - bearerAuth: []
  /executions/{id}/healing-status:
    get:
      summary: Get execution healing status
      description: Returns the current self-healing status for an execution, including healing attempts, fixes applied, and remaining issues.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Healing status details
          content:
            application/json:
              schema:
                type: object
                properties:
                  executionArn:
                    type: string
                  healing_active:
                    type: boolean
                    description: "Whether self-healing is currently active"
                  healing_attempts:
                    type: integer
                    description: "Number of healing attempts made"
                  max_attempts:
                    type: integer
                    description: "Maximum allowed healing attempts"
                  current_strategy:
                    type: string
                    enum: [retry, fallback, skip, escalate]
                    description: "Current healing strategy being applied"
                  fixes_applied:
                    type: array
                    items:
                      type: object
                      properties:
                        timestamp:
                          type: string
                          format: date-time
                        issue_type:
                          type: string
                        fix_description:
                          type: string
                        success:
                          type: boolean
                  remaining_issues:
                    type: array
                    items:
                      type: object
                      properties:
                        issue_id:
                          type: string
                        issue_type:
                          type: string
                        severity:
                          type: string
                          enum: [low, medium, high, critical]
                        description:
                          type: string
                  last_healing_at:
                    type: string
                    format: date-time
                    nullable: true
        '404':
          description: Execution not found
      security:
        - bearerAuth: []
  /notifications:
    get:
      summary: Get notifications
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, sent]
        - name: type
          in: query
          schema:
            type: string
            enum: [hitp_pause, execution_progress]
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: nextToken
          in: query
          schema:
            type: string
      responses:
        '200':
          description: List of notifications
          content:
            application/json:
              schema:
                type: object
                properties:
                  notifications:
                    type: array
                    items:
                      type: object
                      properties:
                        notificationId:
                          type: string
                        ownerId:
                          type: string
                        timestamp:
                          type: integer
                        status:
                          type: string
                        notification:
                          type: object
                        ttl:
                          type: integer
                  nextToken:
                    type: string
      security:
        - bearerAuth: []
  # =========================================================================
  # Task Manager API (v2.1)
  # =========================================================================
  /tasks:
    get:
      summary: List tasks
      description: Get list of tasks for the authenticated user (business-friendly view)
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [queued, in_progress, pending_approval, completed, failed, cancelled]
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
        - name: include_completed
          in: query
          schema:
            type: boolean
            default: true
      responses:
        '200':
          description: List of tasks
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskListResponse'
      security:
        - bearerAuth: []
  /tasks/{taskId}:
    get:
      summary: Get task detail
      description: Get detailed task information including thought history and artifacts
      parameters:
        - name: taskId
          in: path
          required: true
          schema:
            type: string
        - name: include_technical_logs
          in: query
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Task detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskDetail'
        '404':
          description: Task not found
      security:
        - bearerAuth: []
  /tasks/{taskId}/metrics:
    get:
      summary: Get task business metrics
      description: Get business value metrics (ETA, confidence, throughput)
      parameters:
        - name: taskId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Task metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskMetrics'
        '404':
          description: Task not found
      security:
        - bearerAuth: []
  /tasks/{taskId}/outcomes:
    get:
      summary: Get task outcomes
      description: Get task outcomes (artifacts) with collapsed history
      parameters:
        - name: taskId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Task outcomes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OutcomesResponse'
        '404':
          description: Task not found
      security:
        - bearerAuth: []
  /tasks/{taskId}/outcomes/{artifactId}/reasoning:
    get:
      summary: Get reasoning path for artifact
      description: Get detailed reasoning steps that led to a specific artifact
      parameters:
        - name: taskId
          in: path
          required: true
          schema:
            type: string
        - name: artifactId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Reasoning path
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReasoningPathResponse'
        '404':
          description: Artifact not found
      security:
        - bearerAuth: []
  /tasks/quick-fix:
    post:
      summary: Execute quick fix action
      description: Execute a quick fix action for a failed or stuck task
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QuickFixRequest'
      responses:
        '200':
          description: Quick fix executed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  new_execution_id:
                    type: string
        '400':
          description: Invalid quick fix request
        '404':
          description: Task not found
      security:
        - bearerAuth: []

# ===========================================================================
# WebSocket API Security Information (Non-OpenAPI)
# ===========================================================================
# 
# WebSocket connection endpoint: wss://{api-id}.execute-api.{region}.amazonaws.com/{stage}
# 
# Security Requirements:
# 1. JWT Token Required: Bearer token required in Authorization header when connecting
# 2. JWKS Validation: Actual Cognito JWKS signature verification implemented
# 3. Tenant Isolation: Users can only receive their own notifications
# 
# Connection Examples:
# 
# JavaScript:
# const ws = new WebSocket('wss://api-id.execute-api.region.amazonaws.com/stage', [], {
#   headers: { 'Authorization': `Bearer ${jwtToken}` }
# });
# 
# Python:
# import websockets
# headers = {"Authorization": f"Bearer {jwt_token}"}
# async with websockets.connect("wss://...", extra_headers=headers) as websocket:
#     ...
# 
# Security Improvements (v2.0.0):
# - âœ… Actual JWKS signature verification (improved from previous fake verification)
# - âœ… Prevent stale connections with TTL-based connection cleanup
# - âœ… ownerId-based notification isolation blocks cross-tenant access
# ===========================================================================

